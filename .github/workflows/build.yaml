name: Build

on:
  push:
  pull_request:

# Only allow running one build per branch at a time to optimise cache hits
concurrency:
  group: builds-${{ github.ref }}

defaults:
  run:
    shell: bash

jobs:
  prepare:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.matrix.outputs.result }}
      mod_version: ${{ steps.mod_version.outputs.version }}
      do_release: ${{ steps.release.outputs.do_release }}

    steps:
      - name: Checkout versions file
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            stonecutter.versions.toml
            gradle.properties
          sparse-checkout-cone-mode: false

      - name: Read mod version
        id: mod_version
        run: |
          version=$(sed -n 's/^mod_version=//p' gradle.properties)
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Check if a release should be made
        id: release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ github.token }}
          local: ${{ steps.mod_version.outputs.version }}
        run: |
          # Get the version from the newest published release
          published=$(gh release view --json tagName --jq .tagName 2>/dev/null || echo "")
          published="${published#v}"

          # Determine the latest version
          latest=$(printf "%s\n" "$published" "$local" | sort --version-sort | tail -n1)

          # Do a release if local is newer than published
          if [ "$local" = "$latest" ] && [ "$local" != "$published" ]; then
            echo "Pushed version $local is newer than latest release $published"
            echo "do_release=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate versions matrix
        id: matrix
        uses: mikefarah/yq@v4
        with:
          cmd: |
            yq --output-format=json --indent=0 '
              to_entries | map({
                "minecraft": .key,
                "projects": (.value.projects - ["common"])
              })
            ' stonecutter.versions.toml

  build:
    name: Build (${{ matrix.minecraft }})
    runs-on: ubuntu-latest

    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    timeout-minutes: 120
    env:
      artifact_name: freecam-${{ matrix.minecraft }}-builds

    steps:
      - uses: actions/checkout@v6

      # Install Java used by the Gradle wrapper.
      # The JVM used to build is installed separately by the foojay resolver.
      - uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: temurin
      - uses: gradle/actions/setup-gradle@v5

      - name: Build for MC ${{ matrix.minecraft }}
        env:
          task: buildAndCollect
          minecraft: ${{ matrix.minecraft }}
          projects: ${{ toJSON(matrix.projects) }}
        run: |
          # Build each :<project>:<version>:<task> task
          mapfile -t tasks < <(
            echo "$projects" | jq --raw-output --arg mc "$minecraft" --arg task "$task" '
              .[] | ["", ., $mc, $task] | join(":")
            '
          )
          ./gradlew "${tasks[@]}"

      # actions/upload-artifact preserves the full path from the first glob it sees.
      # Capture the actual versioned build dir to avoid including parent directories in the artifact.
      - name: Find build dir
        shell: bash
        env:
          base_dir: build/libs
        run: |
          mapfile -t versions < <(
            find "$base_dir" -maxdepth 1 -mindepth 1 -type d -exec basename {} ';'
          )

          if (( ${#versions[@]} > 1 )); then
            echo "::error::Multiple Freecam versions were built: ${versions[*]}"
            exit 1
          elif (( ${#versions[@]} < 1 )); then
            echo "::error::No Freecam versions were built."
            exit 1
          fi

          version="${versions[0]}"
          echo "Found version $version in $base_dir"
          echo "version_dir=$base_dir/$version" >> "$GITHUB_ENV"

      - name: Upload builds
        id: upload
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.artifact_name }}
          path: ${{ env.version_dir }}/*.jar
          retention-days: 90
          if-no-files-found: error

      - name: Upload summary
        shell: bash
        env:
          artifact_url: ${{ steps.upload.outputs.artifact-url }}
        run: |
          mapfile -t jars < <(
            # Sort by MC version first (descending), then lexicographically
            # Field 2 is "+mc<version>"; .3 skips the "mc" prefix
            # Key flags: V = version sort, r = reverse
            printf '%s\n' "$version_dir"/*.jar |
            sed 's|.*/||' |
            sort \
              --field-separator=+ \
              --key=2.3Vr,2 \
              --key=1,1
          )

          {
            echo "## Build artifacts"
            echo
            echo "**Files:**"
            echo
            for jar in "${jars[@]}"; do
              echo "- \`$jar\`"
            done
            echo
            echo "**Download:** [$artifact_name.zip]($artifact_url)"
            echo
            echo "_Expires on **$(date --utc --date=+90days +%F)** (UTC)._"
            echo
          } >> "$GITHUB_STEP_SUMMARY"
